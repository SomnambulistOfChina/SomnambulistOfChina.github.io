<!DOCTYPE html>


  <html class="light page-post">


<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <title>15 web-文件的上传和下载 | SomnambulistOfChina</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta name="keywords" content="JavaWeb概述,">
  

  <meta name="description" content="文件的上传和下载 文件的上传和下载在web应用中是非常常用，也是非常有用的功能。 例如：发送电子邮件时可以同过上传附件发送文件，OA系统中可以通过上传文件来提交公文，社交网站通过上传图片来自定义头像等等。 例如：下载实际上只要资源放在用户可访问的目录中用户就可以直接通过地址下载，但是一些资源是存放到数据库中的，还有一些资源需要一定权限才能下载，这里就需要我们通过Servlet来完成下载的功能。">
<meta name="keywords" content="JavaWeb概述">
<meta property="og:type" content="article">
<meta property="og:title" content="15 web-文件的上传和下载">
<meta property="og:url" content="http://yoursite.com/2017/09/25/34 web-文件的上传和下载/index.html">
<meta property="og:site_name" content="SomnambulistOfChina">
<meta property="og:description" content="文件的上传和下载 文件的上传和下载在web应用中是非常常用，也是非常有用的功能。 例如：发送电子邮件时可以同过上传附件发送文件，OA系统中可以通过上传文件来提交公文，社交网站通过上传图片来自定义头像等等。 例如：下载实际上只要资源放在用户可访问的目录中用户就可以直接通过地址下载，但是一些资源是存放到数据库中的，还有一些资源需要一定权限才能下载，这里就需要我们通过Servlet来完成下载的功能。">
<meta property="og:locale" content="Java EE">
<meta property="og:image" content="https://raw.githubusercontent.com/SomnambulistOfChina/photo_GitHub/master/photo/20190606161759.png">
<meta property="og:updated_time" content="2019-06-06T15:03:11.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="15 web-文件的上传和下载">
<meta name="twitter:description" content="文件的上传和下载 文件的上传和下载在web应用中是非常常用，也是非常有用的功能。 例如：发送电子邮件时可以同过上传附件发送文件，OA系统中可以通过上传文件来提交公文，社交网站通过上传图片来自定义头像等等。 例如：下载实际上只要资源放在用户可访问的目录中用户就可以直接通过地址下载，但是一些资源是存放到数据库中的，还有一些资源需要一定权限才能下载，这里就需要我们通过Servlet来完成下载的功能。">
<meta name="twitter:image" content="https://raw.githubusercontent.com/SomnambulistOfChina/photo_GitHub/master/photo/20190606161759.png">

  

  
    <link rel="icon" href="/favicon.ico">
  

  <link href="/css/styles.css?v=c114cbeddx" rel="stylesheet">


  
    <link rel="stylesheet" href="/css/personal-style.css">
  

  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-38189205-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


  
  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?99d997f72fffd95d0fd1477dd657eafc";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>


  
  <script type="text/javascript">
	(function(){
	    var bp = document.createElement('script');
	    var curProtocol = window.location.protocol.split(':')[0];
	    if (curProtocol === 'https') {
	        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
	    }
	    else {
	        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
	    }
	    var s = document.getElementsByTagName("script")[0];
	    s.parentNode.insertBefore(bp, s);
	})();
  </script>



  
    <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.3.0/css/font-awesome.min.css">
  
  
</head>
</html>
<body>


  
    <span id="toolbox-mobile" class="toolbox-mobile">更多</span>
  

  <div class="post-header CENTER">
   
  <div class="toolbox">
    <a class="toolbox-entry" href="/">
      <span class="toolbox-entry-text">更多</span>
      <i class="icon-angle-down"></i>
      <i class="icon-home"></i>
    </a>
    <ul class="list-toolbox">
      
        <li class="item-toolbox">
          <a class="CIRCLE" href="/archives/" rel="noopener noreferrer" target="_self">
            博客
          </a>
        </li>
      
        <li class="item-toolbox">
          <a class="CIRCLE" href="/category/" rel="noopener noreferrer" target="_self">
            分类
          </a>
        </li>
      
        <li class="item-toolbox">
          <a class="CIRCLE" href="/tag/" rel="noopener noreferrer" target="_self">
            标签
          </a>
        </li>
      
        <li class="item-toolbox">
          <a class="CIRCLE" href="/link/" rel="noopener noreferrer" target="_self">
            友链
          </a>
        </li>
      
        <li class="item-toolbox">
          <a class="CIRCLE" href="/about/" rel="noopener noreferrer" target="_self">
            关于
          </a>
        </li>
      
        <li class="item-toolbox">
          <a class="CIRCLE" href="/search/" rel="noopener noreferrer" target="_self">
            搜索
          </a>
        </li>
      
        <li class="item-toolbox">
          <a class="CIRCLE" href="/atom.xml" rel="noopener noreferrer" target="_blank">
            RSS
          </a>
        </li>
      
    </ul>
  </div>


</div>


  <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#文件的上传和下载"><span class="toc-text">文件的上传和下载</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#文件的上传"><span class="toc-text">文件的上传</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#创建上传文件的表单"><span class="toc-text">创建上传文件的表单</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-创建一个form表单"><span class="toc-text">1.    创建一个form表单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-编写Servelet。"><span class="toc-text">2.    编写Servelet。</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#commons-fileupload。"><span class="toc-text">commons-fileupload。</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-DiskFileItemFactory"><span class="toc-text">1.    DiskFileItemFactory</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-ServletFileUpload"><span class="toc-text">2.    ServletFileUpload</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-FileItem"><span class="toc-text">3.    FileItem</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#文件的下载"><span class="toc-text">文件的下载</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#步骤："><span class="toc-text">步骤：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-获取文件的流："><span class="toc-text">1.    获取文件的流：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-获取头信息"><span class="toc-text">2.    获取头信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-设置头信息"><span class="toc-text">3.    设置头信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-发送文件"><span class="toc-text">4.    发送文件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#乱码："><span class="toc-text">乱码：</span></a></li></ol></li></ol>
  </div>



<div class="content content-post CENTER">
   <article id="post-34 web-文件的上传和下载" class="article article-type-post" itemprop="blogPost">
  <header class="article-header">
    <h1 class="post-title">15 web-文件的上传和下载</h1>

    <div class="article-meta">
      <span>
        <i class="icon-calendar"></i>
        <span>2017.09.25</span>
      </span>

      
        <span class="article-author">
          <i class="icon-user"></i>
          <span>SomnambulistOfChina</span>
        </span>
      

      
  <span class="article-category">
    <i class="icon-list"></i>
    <a class="article-category-link" href="/categories/JavaWeb/">JavaWeb</a>
  </span>



      

      
      <i class="fa fa-eye"></i> 
        <span id="busuanzi_container_page_pv">
           &nbsp热度 <span id="busuanzi_value_page_pv">
           <i class="fa fa-spinner fa-spin"></i></span>℃
        </span>
      
      
    </div>
  </header>

  <div class="article-content">
    
      <h1 id="文件的上传和下载"><a href="#文件的上传和下载" class="headerlink" title="文件的上传和下载"></a>文件的上传和下载</h1><ul>
<li>文件的上传和下载在web应用中是非常常用，也是非常有用的功能。<ul>
<li>例如：发送电子邮件时可以同过上传附件发送文件，OA系统中可以通过上传文件来提交公文，社交网站通过上传图片来自定义头像等等。</li>
<li>例如：下载实际上只要资源放在用户可访问的目录中用户就可以直接通过地址下载，但是一些资源是存放到数据库中的，还有一些资源需要一定权限才能下载，这里就需要我们通过Servlet来完成下载的功能。</li>
</ul>
</li>
</ul>
<ul>
<li>可以说上传和下载是每一个web应用都需要具有的一个功能，所以需要我们掌握。</li>
</ul>
<h1 id="文件的上传"><a href="#文件的上传" class="headerlink" title="文件的上传"></a>文件的上传</h1><p>文件的上传主要分成两个步骤</p>
<pre><code>- 用户在页面中选择要上传的文件，然后将请求提交到Servlet
- Servlet收到请求，解析用户上传的文件，然后将文件存储到服务器
</code></pre><h2 id="创建上传文件的表单"><a href="#创建上传文件的表单" class="headerlink" title="创建上传文件的表单"></a>创建上传文件的表单</h2><h3 id="1-创建一个form表单"><a href="#1-创建一个form表单" class="headerlink" title="1.    创建一个form表单"></a>1.    创建一个form表单</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;form action=&quot;&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;&gt;</span><br><span class="line">	&lt;input type=&quot;file&quot; name=&quot;file&quot; /&gt;&lt;br /&gt;&lt;br /&gt;</span><br><span class="line">	&lt;input type=&quot;submit&quot; value=&quot;上传&quot; /&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure>
<p>文件上传的表单和之前的表单类似，但有以下内容需要注意</p>
<ul>
<li>表单的method属性必须为post</li>
<li>表单的enctype属性必须为multipart/form-data</li>
<li>上传文件的控件是input，type属性为file</li>
</ul>
<p>该表单打开后是如下效果：</p>
<p><img src="https://raw.githubusercontent.com/SomnambulistOfChina/photo_GitHub/master/photo/20190606161759.png" alt></p>
<h3 id="2-编写Servelet。"><a href="#2-编写Servelet。" class="headerlink" title="2.    编写Servelet。"></a>2.    编写Servelet。</h3><ul>
<li>页面的表单控件创建好以后，选中文件点击上传按钮请求将会提交到指定的Servlet来处理。</li>
<li>注意：这里不能再像以前的Servlet中那样，通过request.getParamter()来获取请求参数了，当enctype=”multipart/form-data” 时，再使用getParamter()获取到内容永远为空。因为浏览器发送请求的方式已经改变。</li>
<li>既然以前的方法不能使用了，这里我们必须要引入一个新的工具来解析请求中的参数和文件，这个工具就是commons-fileupload。</li>
</ul>
<h2 id="commons-fileupload。"><a href="#commons-fileupload。" class="headerlink" title="commons-fileupload。"></a>commons-fileupload。</h2><ul>
<li>commons-fileupload是Apache开发的一款专门用来处理上传的工具，它的作用就是可以从request对象中解析出，用户发送的请求参数和上传文件的流。</li>
<li>commons-fileupload包依赖commons-io，两个包需要同时导入。</li>
<li>核心类：</li>
</ul>
<h3 id="1-DiskFileItemFactory"><a href="#1-DiskFileItemFactory" class="headerlink" title="1.    DiskFileItemFactory"></a>1.    DiskFileItemFactory</h3><ul>
<li>工厂类，用于创建ServletFileUpload，设置缓存等  </li>
<li>该类一般直接使用构造器直接创建实例</li>
<li>方法：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public void setSizeThreshold(int sizeThreshold)</span><br><span class="line">   	用于设置缓存文件的大小（默认值10kb）</span><br><span class="line">public void setRepository(File repository)</span><br><span class="line">   	用于设置缓存文件位置（默认系统缓存目录）</span><br></pre></td></tr></table></figure>
<h3 id="2-ServletFileUpload"><a href="#2-ServletFileUpload" class="headerlink" title="2.    ServletFileUpload"></a>2.    ServletFileUpload</h3><ul>
<li>该类用于解析request对象从而获取用户发送的请求参数（包括普通参数和文件参数）</li>
<li>该类需要调用有参构造器创建实例，构造器中需要一个Di- skFileItemFactory作为参数</li>
<li>方法：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public List&lt;FileItem&gt; parseRequest(HttpServletRequest request)</span><br><span class="line">	解析request对象，获取请求参数，返回的是一个List，</span><br><span class="line">	List中保存的是一个FileItem对象，一个对象代表一个请求参数。</span><br><span class="line">public void setFileSizeMax(long fileSizeMax)</span><br><span class="line">	设置单个文件的大小限制，单位为B</span><br><span class="line">	如果上传文件超出限制，会在parseRequest()抛出异常</span><br><span class="line">        FileSizeLimitExceededException。</span><br><span class="line">public void setSizeMax(long sizeMax)</span><br><span class="line">	限制请求内容的总大小，单位为B</span><br><span class="line">	如果上传文件超出限制，会在parseRequest()抛出异常</span><br><span class="line">    	SizeLimitExceededException。</span><br></pre></td></tr></table></figure>
<h3 id="3-FileItem"><a href="#3-FileItem" class="headerlink" title="3.    FileItem"></a>3.    FileItem</h3><ul>
<li>该类用于封装用户发送的参数和文件，也就是用户发送来的信息将会被封装成一个FileItem对象，我们通过该对象获取请求参数或上传文件的信息。</li>
<li>该类不用我们手动创建，由ServletFileItem解析request后返回。</li>
<li>方法：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">String getFieldName()</span><br><span class="line">	获取表单项的名字，也就是input当中的name属性的值。</span><br><span class="line">String getName();</span><br><span class="line">	获取上传的文件名，普通的请求参数为null。</span><br><span class="line">String getString(String encoding);</span><br><span class="line">	获取内容</span><br><span class="line">    	若为文件，将文件的流转换为字符串。</span><br><span class="line">    	若为请求参数，则获取请求参数的value。</span><br><span class="line">	encoding参数需要指定一个字符集</span><br><span class="line">boolean isFormField();</span><br><span class="line">	判断当前的FileItem封装的是普通请求参数，还是一个文件。</span><br><span class="line">    	如果为普通参数返回：true</span><br><span class="line">    	如果为文件参数返回：false</span><br><span class="line">String getContentType();</span><br><span class="line">	获取上传文件的MIME类型</span><br><span class="line">long getSize();</span><br><span class="line">	获取内容的大小</span><br></pre></td></tr></table></figure>
<ul>
<li>实例代码，创建一个Servlet并在doPost()方法中编写如下代码:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">//创建工厂类</span><br><span class="line">DiskFileItemFactory factory = new DiskFileItemFactory();</span><br><span class="line">//创建请求解析器</span><br><span class="line">ServletFileUpload fileUpload = new ServletFileUpload(factory);</span><br><span class="line">//设置上传单个文件的的大小</span><br><span class="line">fileUpload.setFileSizeMax(1024*1024*3);</span><br><span class="line">//设置上传总文件的大小</span><br><span class="line">fileUpload.setSizeMax(1024*1024*3*10);</span><br><span class="line">//设置响应内容的编码</span><br><span class="line">response.setContentType(&quot;text/html;charset=utf-8&quot;);</span><br><span class="line">try &#123;</span><br><span class="line">	//解析请求信息，获取FileItem的集合</span><br><span class="line">	List&lt;FileItem&gt; items = fileUpload.parseRequest(request);</span><br><span class="line">	//遍历集合</span><br><span class="line">	for (FileItem fileItem : items) &#123;</span><br><span class="line">		//如果是普通的表单项</span><br><span class="line">		if(fileItem.isFormField())&#123;</span><br><span class="line">		    //获取参数名</span><br><span class="line">		    String fieldName = fileItem.getFieldName();</span><br><span class="line">		    //获取参数值</span><br><span class="line">		    String value = fileItem.getString(&quot;utf-8&quot;);</span><br><span class="line">		    System.out.println(fieldName+&quot; = &quot;+value);</span><br><span class="line">	        //如果是文件表单项</span><br><span class="line">	    &#125;else&#123;</span><br><span class="line">		    //获取文件名</span><br><span class="line">		    String fileName = fileItem.getName();</span><br><span class="line">		    //获取上传路径</span><br><span class="line">		    String realPath = getServletContext().getRealPath(&quot;/WEB-INF/upload&quot;);</span><br><span class="line">		    //检查upload文件夹是否存在，如果不存在则创建</span><br><span class="line">		    File f = new File(realPath);</span><br><span class="line">		    if(!f.exists())&#123;</span><br><span class="line">			    f.mkdir();</span><br><span class="line">		    &#125;;</span><br><span class="line">		    //为避免重名生成一个uuid作为文件名的前缀</span><br><span class="line">		    String prefix = UUID.randomUUID().toString().replace(&quot;-&quot;, &quot;&quot;);</span><br><span class="line">		    //将文件写入到服务器中</span><br><span class="line">		    fileItem.write(new File(realPath+&quot;/&quot;+prefix+&quot;_&quot;+fileName));</span><br><span class="line">		    //清楚文件缓存</span><br><span class="line">		    fileItem.delete();</span><br><span class="line">	    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125; catch (Exception e) &#123;</span><br><span class="line">	if(e instanceof SizeLimitExceededException)&#123;</span><br><span class="line">		//文件总大小超出限制</span><br><span class="line">		response.getWriter().print(&quot;上传文件的总大小不能超过30M&quot;);</span><br><span class="line">	&#125;else if(e instanceof FileSizeLimitExceededException)&#123;</span><br><span class="line">		//单个文件大小超出限制</span><br><span class="line">		response.getWriter().print(&quot;上传单个文件的大小不能超过3M&quot;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125; </span><br><span class="line">response.getWriter().print(&quot;上传成功&quot;);</span><br></pre></td></tr></table></figure>
<h1 id="文件的下载"><a href="#文件的下载" class="headerlink" title="文件的下载"></a>文件的下载</h1><ul>
<li>文件下载最直接的方法就是把文件直接放到服务器的目录中，用户直接访问该文件就可以直接下载。</li>
<li>但是实际上这种方式并不一定好用，比如我们在服务器上直接放置一个MP3文件，然后通过浏览器访问该文件的地址，如果是IE浏览器可能就会弹出下载窗口，而如果是FireFox和Chrome则有可能直接播放。再有就是有一些文件我们是不希望用户可以直接访问到的，这是我们就要通过Servlet来完成下载功能。</li>
<li>下载文件的关键是几点：<br>1     服务器以一个流的形式将文件发送给浏览器。<br>2      发送流的同时还需要设置几个响应头，来告诉浏览器下载的信息。</li>
<li>具体响应头如下：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Content-Type</span><br><span class="line">	下载文件的MIME类型</span><br><span class="line">	可以通过servletContext. getMimeType(String file)获取</span><br><span class="line">	也可以直接手动指定</span><br><span class="line">	使用response.setContentType(String type);</span><br><span class="line">	响应头样式：</span><br><span class="line">    	Content-Type: audio/mpeg</span><br><span class="line">Content-Disposition</span><br><span class="line">	下载文件的名字，主要作用是提供一个默认的用户名</span><br><span class="line">	通过response.setHeader(&quot;Content-Disposition&quot;, disposition)设置</span><br><span class="line">	响应头样式：</span><br><span class="line">    	Content-Disposition: attachment; filename=xxx.mp3</span><br><span class="line">Content-Length</span><br><span class="line">	下载文件的长度，用于设置文件的长处（不必须）</span><br><span class="line">	通过response. setContentLength(int len)设置。</span><br><span class="line">	设置后样式：</span><br><span class="line">    	Content-Length: 3140995</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>接下来需要以输入流的形式读入硬盘上的文件</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FileInputStream is = new FileInputStream(file);</span><br><span class="line">这个流就是我们一会要发送给浏览器的内容</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>通过response获取一个输出流，并将文件（输入流）通过该流发送给浏览器</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">获取输出流</span><br><span class="line">	ServletOutputStream out = response.getOutputStream();</span><br><span class="line">通过输出流向浏览器发送文件（不要忘了关闭输入流）</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">byte[] b = new byte[1024];</span><br><span class="line">int len = 0;</span><br><span class="line">while((len=is.read(b))&gt; 0)&#123;</span><br><span class="line">	out.write(b, 0, len);</span><br><span class="line">&#125;</span><br><span class="line">is.close();</span><br></pre></td></tr></table></figure>
<h2 id="步骤："><a href="#步骤：" class="headerlink" title="步骤："></a>步骤：</h2><ul>
<li>一下步骤都是在同一个Servlet的doGet()方法中编写的</li>
<li>我所下载的文件是放在WEB-INF下mp3文件夹中的文件</li>
<li>具体步骤</li>
</ul>
<h3 id="1-获取文件的流："><a href="#1-获取文件的流：" class="headerlink" title="1.    获取文件的流："></a>1.    获取文件的流：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">String realPath = getServletContext().getRealPath(&quot;/WEB-INF/mp3/中国话.mp3&quot;);</span><br><span class="line">//获取文件的File对象</span><br><span class="line">File file = new File(realPath);</span><br><span class="line">//获取文件的输入流</span><br><span class="line">FileInputStream is = new FileInputStream(file);</span><br></pre></td></tr></table></figure>
<h3 id="2-获取头信息"><a href="#2-获取头信息" class="headerlink" title="2.    获取头信息"></a>2.    获取头信息</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//获取文件的MIME信息</span><br><span class="line">String contentType = getServletContext().getMimeType(realPath);</span><br><span class="line">//设置下载文件的名字</span><br><span class="line">String filename = &quot;zhongguohua.mp3&quot;;</span><br><span class="line">//创建Content-Disposition信息</span><br><span class="line">String disposition = &quot;attachment; filename=&quot;+ filename ;</span><br><span class="line">//获取文件长度</span><br><span class="line">long size = file.length();</span><br></pre></td></tr></table></figure>
<h3 id="3-设置头信息"><a href="#3-设置头信息" class="headerlink" title="3.    设置头信息"></a>3.    设置头信息</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//设置Content-Type</span><br><span class="line">response.setContentType(contentType);</span><br><span class="line">//设置Content-Disposition</span><br><span class="line">response.setHeader(&quot;Content-Disposition&quot;, disposition);</span><br><span class="line">//设置文件长度</span><br><span class="line">response.setContentLength((int)size);</span><br></pre></td></tr></table></figure>
<h3 id="4-发送文件"><a href="#4-发送文件" class="headerlink" title="4.    发送文件"></a>4.    发送文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">//通过response获取输出流，用于向浏览器输出内容</span><br><span class="line">ServletOutputStream out = response.getOutputStream();</span><br><span class="line">//将文件输入流通过输出流输出</span><br><span class="line">byte[] b = new byte[1024];</span><br><span class="line">int len = 0;</span><br><span class="line">while((len=is.read(b))&gt; 0)&#123;</span><br><span class="line">	out.write(b, 0, len);</span><br><span class="line">&#125;</span><br><span class="line">//最后不要忘记关闭输入流，输出流由Tomcat自己处理，我们不用手动关闭</span><br><span class="line">is.close();</span><br></pre></td></tr></table></figure>
<h2 id="乱码："><a href="#乱码：" class="headerlink" title="乱码："></a>乱码：</h2><ul>
<li>至此实际上文件下载的主要功能都已经完成。但是还有一个问题我们这里没有体现出来，因为目前我们的文件名使用的是纯英文的，没有乱码问题。这里如果我们要使用中文文件名的话，毫无疑问会出现乱码问题。</li>
<li>解决此问题的方法很简单，在获取文件名之后为文件名进行编码：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">filename = java.net.URLEncoder.encode(filename,&quot;utf-8&quot;);</span><br></pre></td></tr></table></figure>
<ul>
<li>但是注意这里火狐浏览器比较特殊，因为他默认是以BASE64解码的，所以这块如果需要考虑火狐的问题的话还需要特殊处理一下。</li>
</ul>
<ol>
<li>先要获取客户端信息（通过获取请求头中的User-Agent信息）</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//获取客户端信息</span><br><span class="line">String ua = request.getHeader(&quot;User-Agent&quot;);</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>然后判断浏览器版本，做不同的处理（通过判断头信息中是否包含Firefox字符串来判断浏览器版本）</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//判断客户端是否为火狐</span><br><span class="line">if(ua.contains(&quot;Firefox&quot;))&#123;</span><br><span class="line">	//若为火狐使用BASE64编码</span><br><span class="line">	filename = &quot;=?utf-8?B?&quot;+new BASE64Encoder()</span><br><span class="line">.encode(filename.getBytes(&quot;utf-8&quot;))+&quot;?=&quot;;</span><br><span class="line">&#125;else&#123;</span><br><span class="line">	//否则使用UTF-8</span><br><span class="line">	filename = URLEncoder.encode(filename,&quot;utf-8&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

    
  </div>

</article>


   
  <div class="text-center donation">
    <div class="inner-donation">
      <span class="btn-donation">支持一下</span>
      <div class="donation-body">
        <div class="tip text-center">扫一扫，支持forsigner</div>
        <ul>
        
          <li class="item">
            
              <span>微信扫一扫</span>
            
            <img src="/images/qr-wechat.jpeg" alt>
          </li>
        
          <li class="item">
            
              <span>支付宝扫一扫</span>
            
            <img src="/images/qr-alipay.jpeg" alt>
          </li>
        
        </ul>
      </div>
    </div>
  </div>


   
  <div class="box-prev-next clearfix">
    <a class="show pull-left" href="/2017/09/25/33 web-异步 AJAX/">
        <i class="icon icon-angle-left"></i>
    </a>
    <a class="show pull-right" href="/2017/10/01/20 HTML基础/">
        <i class="icon icon-angle-right"></i>
    </a>
  </div>




</div>


  <a id="backTop" class="back-top">
    <i class="icon-angle-up"></i>
  </a>




  <div class="modal" id="modal">
  <span id="cover" class="cover hide"></span>
  <div id="modal-dialog" class="modal-dialog hide-dialog">
    <div class="modal-header">
      <span id="close" class="btn-close">关闭</span>
    </div>
    <hr>
    <div class="modal-body">
      <ul class="list-toolbox">
        
          <li class="item-toolbox">
            <a class="CIRCLE" href="/archives/" rel="noopener noreferrer" target="_self">
              博客
            </a>
          </li>
        
          <li class="item-toolbox">
            <a class="CIRCLE" href="/category/" rel="noopener noreferrer" target="_self">
              分类
            </a>
          </li>
        
          <li class="item-toolbox">
            <a class="CIRCLE" href="/tag/" rel="noopener noreferrer" target="_self">
              标签
            </a>
          </li>
        
          <li class="item-toolbox">
            <a class="CIRCLE" href="/link/" rel="noopener noreferrer" target="_self">
              友链
            </a>
          </li>
        
          <li class="item-toolbox">
            <a class="CIRCLE" href="/about/" rel="noopener noreferrer" target="_self">
              关于
            </a>
          </li>
        
          <li class="item-toolbox">
            <a class="CIRCLE" href="/search/" rel="noopener noreferrer" target="_self">
              搜索
            </a>
          </li>
        
          <li class="item-toolbox">
            <a class="CIRCLE" href="/atom.xml" rel="noopener noreferrer" target="_blank">
              RSS
            </a>
          </li>
        
      </ul>

    </div>
  </div>
</div>



  
      <div class="fexo-comments comments-post">
    

    

    
    

    

    
    

    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js"></script>
    <div id="comment" class="vcomment"></div>
    <script>
        var notify = 'false' == true ? true : false;
        var verify = 'false' == true ? true : false;
        var GUEST_INFO = ['nick','mail','link'];
        var guest_info = 'nick,mail,link'.split(',').filter(function(item){
            return GUEST_INFO.indexOf(item) > -1
        });
        guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
        window.valine = new Valine({
            el: '.vcomment',
            notify: notify,
            verify: verify,
            appId: "b8cfVAxSX9whYsIOMmxwCicp-gzGzoHsz",
            appKey: "klYDKAeEh6GPa0wnf22lQd96",
            avatar:'identicon',
            placeholder: "ヾﾉ≧∀≦)o 来呀！快活呀！~",
            guest_info:guest_info,
            pageSize:'10'
        });
    </script>
  
    

  </div>

  

  <script type="text/javascript">
  function loadScript(url, callback) {
    var script = document.createElement('script')
    script.type = 'text/javascript';

    if (script.readyState) { //IE
      script.onreadystatechange = function() {
        if (script.readyState == 'loaded' ||
          script.readyState == 'complete') {
          script.onreadystatechange = null;
          callback();
        }
      };
    } else { //Others
      script.onload = function() {
        callback();
      };
    }

    script.src = url;
    document.getElementsByTagName('head')[0].appendChild(script);
  }

  window.onload = function() {
    loadScript('/js/bundle.js?235683', function() {
      // load success
    });
  }
</script>

</body>
</html>
